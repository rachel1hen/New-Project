name: Zonos TTS (Inline Inference)

on:
  workflow_dispatch:

jobs:
  zonos-inference:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo (optional)
      uses: actions/checkout@v3

    - name: Install system dependencies
      run: |
        #sudo apt-get update
        sudo apt-get install -y espeak-ng #python3-pip git

    - name: Clone and install Zonos
      run: |
        git clone https://github.com/Zyphra/Zonos.git
        cd Zonos
        pip install --upgrade pip
        pip install -e .
        pip install torch  # CPU version

    - name: Run Zonos TTS inline
      run: |
        cd Zonos
     
        python - << 'EOF'
        import torch
        import torchaudio
        from zonos.model import Zonos
        from zonos.conditioning import make_cond_dict
        
        # Force usage of CPU
        device = torch.device("cpu")
        
        model = Zonos.from_pretrained("Zyphra/Zonos-v0.1-transformer", device=device)
        
        # Optional: no speaker cloning
        cond_dict = make_cond_dict(text="Hello from GitHub Actions on CPU-only.", speaker=None, language="en-us")
        conditioning = model.prepare_conditioning(cond_dict)
        
        codes = model.generate(conditioning)
        
        wavs = model.autoencoder.decode(codes).cpu()
        torchaudio.save("output.wav", wavs[0], model.autoencoder.sampling_rate)
        EOF

    - name: Upload generated audio
      uses: actions/upload-artifact@v4
      with:
        name: zonos-tts-output
        path: Zonos/output.wav
